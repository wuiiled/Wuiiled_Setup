name: Merge Rules

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  merge-and-clean:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install mihomo
      run: |
        version=$(curl -skL https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/version.txt)
        curl -skLo mihomo.deb "https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/mihomo-linux-amd64-$version.deb"
        sudo dpkg -i mihomo.deb

    - name: Run Existing Conversion Scripts
      run: |
        # 假设这些脚本会生成 ADs_merged.txt 等文件
        bash scripts/convert.sh ads
        bash scripts/convert.sh ais
        bash scripts/convert.sh fakeip

    - name: Download and Process Rules
      shell: bash
      run: |
        mkdir -p rules temp-rules

        # === 定义处理函数 ===
        
        # 1. 通用处理: 去除注释、去除 DOMAIN 前缀等
        process_generic() {
            local url=$1
            local name=$2
            echo "Processing $name..."
            curl -skL "$url" | sed '/^#/d' | sed 's/^DOMAIN,//g' | sed 's/^DOMAIN-SUFFIX,/+./g' | grep -v PROCESS-NAME | grep -v '^$' > "temp-rules/$name.txt"
        }

        # 2. SKK 专用处理: 清理 skk.moe 特有的头部和格式
        process_skk() {
            local url=$1
            local name=$2
            echo "Processing SKK $name..."
            curl -skL "$url" | sed '/^#/d; /skk\.moe/d; /^$/d; s/^DOMAIN-SUFFIX,/+./; s/^DOMAIN,//; /^\+\.$/d; /^[[:space:]]*$/d' > "temp-rules/$name.txt"
        }

        # 3. 直接下载: 仅下载不处理 (Wuiiled 系列)
        download_raw() {
            local url=$1
            local name=$2
            echo "Downloading $name..."
            curl -skL "$url" -o "temp-rules/$name.txt"
        }

        # === 开始并行任务 ===
        
        # 组 1: 通用规则
        process_generic "https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleProxy.list" "AppleProxy" &
        process_generic "https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleCN.list" "AppleCN" &
        process_generic "https://raw.githubusercontent.com/ForestL18/rules-dat/refs/heads/mihomo/geo/classical/private.list" "private" &

        # 组 2: SKK 规则
        # 使用数组循环提交后台任务
        declare -A skk_list=(
            ["alibaba"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/alibaba.txt"
            ["tencent"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/tencent.txt"
            ["bilibili"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bilibili.txt"
            ["xiaomi"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/xiaomi.txt"
            ["bytedance"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bytedance.txt"
            ["baidu"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/baidu.txt"
            ["qihoo360"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/qihoo360.txt"
            ["download"]="https://ruleset.skk.moe/Clash/domainset/download.txt"
        )
        for name in "${!skk_list[@]}"; do
            process_skk "${skk_list[$name]}" "$name" &
        done

        # 组 3: 自定义规则 (Wuiiled)
        base_url="https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules"
        files=("Custom_DNS_DOMAIN" "Custom_DNS_IP" "Custom_Direct_DOMAIN" "Custom_Direct_IP" "Custom_Emby" "Custom_Proxy" "Fake_ip_filter_addon")
        for f in "${files[@]}"; do
            download_raw "$base_url/$f.txt" "$f" &
        done

        # 等待所有后台下载任务完成
        wait
        echo "All downloads finished."

    - name: Convert to MRS and Organize
      run: |
        cd temp-rules
        
        for file in *.txt; do
            filename=$(basename "$file" .txt)
            echo "Converting $filename..."
            
            # 自动判断类型: 如果文件名包含 "_IP"，则使用 ipcidr，否则使用 domain
            rule_type="domain"
            if [[ "$filename" == *"_IP"* ]]; then
                rule_type="ipcidr"
            fi
            
            mihomo convert-ruleset "$rule_type" text "$file" "$filename.mrs"
        done
        
        # 将生成的 mrs 文件移动到 rules 目录
        mv *.mrs ../rules/
        
        # 根据你原脚本的需求，部分 txt 文件也需要保留并移动
        # 这里保留 skk 相关的 txt 和 download.txt
        cp {alibaba,tencent,bilibili,xiaomi,bytedance,baidu,qihoo360,download}.txt ../rules/ 2>/dev/null || true
        
        cd ..
        
        # 移动脚本生成的 merged txt 文件 (如果存在)
        mv ADs_merged.txt AIs_merged.txt Fake_IP_Filter_merged.txt rules/ 2>/dev/null || true

    - name: Commit and push changes
      run: |
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M")
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        
        # 切换到孤儿分支 (Orphan Branch)
        git checkout --orphan mihomo
        
        # 清空当前暂存区和工作目录 (除了 .git)
        git rm -rf .
        
        # 只添加 rules 目录下的文件
        git add rules/*
        
        git commit -m "Auto Update $CURRENT_TIME"
        git push -f origin mihomo

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 2
