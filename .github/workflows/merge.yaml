name: Merge Rules

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  merge-and-clean:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install mihomo
      run: |
        version=$(curl -skL https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/version.txt)
        curl -skLo mihomo.deb "https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/mihomo-linux-amd64-$version.deb"
        sudo dpkg -i mihomo.deb

    - name: Run Existing Conversion Scripts
      run: |
        # 这些脚本会在根目录生成 .txt 和 .mrs 文件
        bash scripts/convert.sh ads
        bash scripts/convert.sh ais
        bash scripts/convert.sh fakeip

    - name: Download and Process Rules
      shell: bash
      run: |
        mkdir -p rules temp-rules

        # === 定义处理函数 ===
        
        # 1. 通用处理
        process_generic() {
            local url=$1
            local name=$2
            echo "Processing $name..."
            curl -skL "$url" | sed '/^#/d' | sed 's/^DOMAIN,//g' | sed 's/^DOMAIN-SUFFIX,/+./g' | grep -v PROCESS-NAME | grep -v '^$' > "temp-rules/$name.txt"
        }

        # 2. SKK 专用处理
        process_skk() {
            local url=$1
            local name=$2
            echo "Processing SKK $name..."
            curl -skL "$url" | sed '/^#/d; /skk\.moe/d; /^$/d; s/^DOMAIN-SUFFIX,/+./; s/^DOMAIN,//; /^\+\.$/d; /^[[:space:]]*$/d' > "temp-rules/$name.txt"
        }

        # 3. 直接下载
        download_raw() {
            local url=$1
            local name=$2
            echo "Downloading $name..."
            curl -skL "$url" -o "temp-rules/$name.txt"
        }

        # === 并行下载任务 ===
        
        process_generic "https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleProxy.list" "AppleProxy" &
        process_generic "https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleCN.list" "AppleCN" &
        process_generic "https://raw.githubusercontent.com/ForestL18/rules-dat/refs/heads/mihomo/geo/classical/private.list" "private" &

        declare -A skk_list=(
            ["alibaba"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/alibaba.txt"
            ["tencent"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/tencent.txt"
            ["bilibili"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bilibili.txt"
            ["xiaomi"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/xiaomi.txt"
            ["bytedance"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bytedance.txt"
            ["baidu"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/baidu.txt"
            ["qihoo360"]="https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/qihoo360.txt"
            ["download"]="https://ruleset.skk.moe/Clash/domainset/download.txt"
        )
        for name in "${!skk_list[@]}"; do
            process_skk "${skk_list[$name]}" "$name" &
        done

        base_url="https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules"
        files=("Custom_DNS_DOMAIN" "Custom_DNS_IP" "Custom_Direct_DOMAIN" "Custom_Direct_IP" "Custom_Emby" "Custom_Proxy" "Fake_ip_filter_addon")
        for f in "${files[@]}"; do
            download_raw "$base_url/$f.txt" "$f" &
        done

        wait
        echo "All downloads finished."

    - name: Convert to MRS and Organize
      run: |
        # 1. 处理 temp-rules 中的新下载文件
        cd temp-rules
        for file in *.txt; do
            filename=$(basename "$file" .txt)
            echo "Converting $filename..."
            
            rule_type="domain"
            if [[ "$filename" == *"_IP"* ]]; then
                rule_type="ipcidr"
            fi
            
            mihomo convert-ruleset "$rule_type" text "$file" "$filename.mrs"
        done
        cd ..

        # 2. 收集文件到 rules 目录
        
        # A. 移动并行下载生成的 mrs
        mv temp-rules/*.mrs rules/
        
        # B. 移动 convert.sh 生成在根目录的 mrs (这里处理你的 convert.sh 生成的文件)
        # 使用 2>/dev/null 防止没有文件时报错
        mv *.mrs rules/ 2>/dev/null || true
        
        # C. 移动需要保留的 txt (SKK系列 + convert.sh 生成的 merged txt)
        mv temp-rules/{alibaba,tencent,bilibili,xiaomi,bytedance,baidu,qihoo360,download}.txt rules/ 2>/dev/null || true
        mv *_merged.txt rules/ 2>/dev/null || true
        
        # 清理临时目录
        rm -rf temp-rules

    - name: Commit and push changes
      run: |
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M")
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git checkout --orphan mihomo
        git rm -rf .
        
        # 此时 rules/ 目录下已经包含了所有来源的 mrs 和 txt
        git add rules/*
        
        git commit -m "Auto Update $CURRENT_TIME"
        git push -f origin mihomo

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 2
