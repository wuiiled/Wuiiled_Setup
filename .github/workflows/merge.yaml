name: Merge Rules All-in-One

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  merge-and-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: 'Asia/Shanghai'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install mihomo
      run: |
        echo "Installing mihomo..."
        version=$(curl -skL https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/version.txt)
        curl -skLo mihomo.deb "https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/mihomo-linux-amd64-$version.deb"
        sudo dpkg -i mihomo.deb

    - name: Run Existing Conversion Scripts
      run: |
        # 运行仓库自带脚本，生成 ADs_merged.txt 等基础文件
        bash scripts/convert.sh ads
        bash scripts/convert.sh ais
        bash scripts/convert.sh fakeip

    - name: Process All Rules
      shell: bash
      run: |
        # =======================================================
        #                 1. 配置区域
        # =======================================================
        
        # --- Mihomo & 通用源 ---
        
        # A. 通用规则
        LIST_GENERIC=(
            "AppleProxy|https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleProxy.list"
            "AppleCN|https://raw.githubusercontent.com/Repcz/Tool/refs/heads/X/mihomo/Rules/AppleCN.list"
            "private|https://raw.githubusercontent.com/ForestL18/rules-dat/refs/heads/mihomo/geo/classical/private.list"
        )

        # B. SKK 规则 (用于 Mihomo 和 MosDNS)
        LIST_SKK=(
            "alibaba|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/alibaba.txt"
            "tencent|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/tencent.txt"
            "bilibili|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bilibili.txt"
            "xiaomi|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/xiaomi.txt"
            "bytedance|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/bytedance.txt"
            "baidu|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/baidu.txt"
            "qihoo360|https://ruleset.skk.moe/Internal/mihomo_nameserver_policy/qihoo360.txt"
            "download|https://ruleset.skk.moe/Clash/domainset/download.txt"
        )

        # C. 原样下载 (用于 Mihomo)
        LIST_RAW=(
            "Custom_DNS_DOMAIN|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_DNS_DOMAIN.txt"
            "Custom_DNS_IP|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_DNS_IP.txt"
            "Custom_Direct_DOMAIN|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_Direct_DOMAIN.txt"
            "Custom_Direct_IP|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_Direct_IP.txt"
            "Custom_Emby|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_Emby.txt"
            "Custom_Proxy|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Custom_Proxy.txt"
            "Fake_ip_filter_addon|https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/master/rules/Fake_ip_filter_addon.txt"
        )

        # --- ADG 专用源 ---
        URL_HTTPDNS="https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/category-httpdns-cn.list"
        URL_PCDN="https://raw.githubusercontent.com/wuiiled/PCDN-mihomo-list/refs/heads/main/pcdn.list"

        # =======================================================
        #                 2. 准备工作
        # =======================================================
        
        # 创建工作目录
        mkdir -p temp_ws output/mihomo output/adg output/mosdns-x

        # 检查本地是否有 convert.sh 生成的 ADs_merged.txt
        # 如果没有则下载备用，保证后续流程不报错
        if [ ! -f "ADs_merged.txt" ]; then
            echo "Local ADs_merged.txt not found, downloading..."
            curl -skLo "ADs_merged.txt" "https://raw.githubusercontent.com/wuiiled/Wuiiled_Setup/refs/heads/mihomo/rules/ADs_merged.txt"
        fi

        # =======================================================
        #                 3. 处理逻辑 - Mihomo
        # =======================================================
        echo ">>> Processing Mihomo Rules..."
        
        func_mihomo_generic() {
            curl -skL "$2" | sed '/^#/d' | sed 's/^DOMAIN,//g' | sed 's/^DOMAIN-SUFFIX,/+./g' | grep -v PROCESS-NAME | grep -v '^$' > "temp_ws/$1.txt"
        }
        func_mihomo_skk() {
            curl -skL "$2" | sed '/^#/d; /skk\.moe/d; /^$/d; s/^DOMAIN-SUFFIX,/+./; s/^DOMAIN,//; /^\+\.$/d; /^[[:space:]]*$/d' > "temp_ws/$1.txt"
        }
        func_mihomo_raw() {
            curl -skL "$2" -o "temp_ws/$1.txt"
        }

        # 3.1 下载
        for i in "${LIST_GENERIC[@]}"; do IFS='|' read -r n u <<< "$i"; func_mihomo_generic "$n" "$u" & done
        for i in "${LIST_SKK[@]}"; do IFS='|' read -r n u <<< "$i"; func_mihomo_skk "$n" "$u" & done
        for i in "${LIST_RAW[@]}"; do IFS='|' read -r n u <<< "$i"; func_mihomo_raw "$n" "$u" & done
        
        wait 

        # 3.2 转换格式
        cd temp_ws
        for file in *.txt; do
            filename=$(basename "$file" .txt)
            rule_type="domain"
            [[ "$filename" == *"_IP"* ]] && rule_type="ipcidr"
            mihomo convert-ruleset "$rule_type" text "$file" "$filename.mrs"
        done
        cd ..

        # 3.3 归档 Mihomo
        mv temp_ws/*.mrs output/mihomo/
        mv temp_ws/*.txt output/mihomo/
        # 收集根目录脚本产物
        mv *.mrs output/mihomo/ 2>/dev/null || true
        cp *_merged.txt output/mihomo/ 2>/dev/null || true # 使用 cp 因为后续任务还需要 ADs_merged.txt

        # =======================================================
        #                 4. 处理逻辑 - AdGuard (ADG)
        # =======================================================
        echo ">>> Processing ADG Rules..."
        
        # 4.1 ADs_merged (转 ADG 格式)
        cat ADs_merged.txt | sed '/^$/d; s/DOMAIN-SUFFIX,/||/g; s/$/^/' > output/adg/ADs_merged_adg.txt
        
        # 4.2 Httpdns
        curl -skL "$URL_HTTPDNS" | sed '/^$/d; s/+./||/g; s/$/^/' > output/adg/Httpdns_adg.txt &

        # 4.3 PCDN
        curl -skL "$URL_PCDN" | sed '/DOMAIN-REGEX,/d; /^#/d; /^$/d; s/DOMAIN-SUFFIX,/||/g; s/DOMAIN,/||/g; s/$/^/' > output/adg/PCDN_adg.txt &

        wait

        # =======================================================
        #                 5. 处理逻辑 - MosDNS-X
        # =======================================================
        echo ">>> Processing MosDNS-X Rules..."

        # 5.1 ADs_merged (转 MosDNS 格式)
        # 逻辑：删除空行 -> 删除 DOMAIN-SUFFIX, -> 删除行首的 +.
        cat ADs_merged.txt | sed '/^$/d; s/DOMAIN-SUFFIX,//g; s/^\+\.//g' > output/mosdns-x/ad_domain_list.txt

        # 5.2 SKK Providers (转 MosDNS 格式: domain:/full:)
        # 重用 LIST_SKK 列表，但应用不同的 sed 逻辑
        func_mosdns_skk() {
            local name=$1
            local url=$2
            # 排除 download.txt (通常不做 provider 用)
            if [[ "$name" == "download" ]]; then return; fi

            echo "MosDNS: $name"
            curl -skL "$url" | sed '/^#/d; /skk\.moe/d; /^$/d; s/^DOMAIN-SUFFIX,/domain:/; s/^DOMAIN,/full:/' > "output/mosdns-x/$name.txt"
        }

        for i in "${LIST_SKK[@]}"; do 
            IFS='|' read -r name url <<< "$i"
            func_mosdns_skk "$name" "$url" & 
        done

        wait

        # =======================================================
        #                 6. 最终清理
        # =======================================================
        rm -rf temp_ws
        # 删除根目录残留的 merged txt (已经 cp 到了 output/mihomo)
        rm -f *_merged.txt 
        
        echo "All processing complete."
        echo "Mihomo files:" && ls output/mihomo | wc -l
        echo "ADG files:" && ls output/adg
        echo "MosDNS files:" && ls output/mosdns-x

    # --- 任务 A: 推送 Mihomo ---
    - name: Push to Mihomo branch
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git checkout --orphan mihomo
        git rm -rf .
        mkdir -p rules
        cp -r output/mihomo/* rules/
        git add rules/*
        git commit -m "Auto Update Mihomo $(date +"%Y-%m-%d %H:%M")"
        git push -f origin mihomo

    # --- 任务 B: 推送 ADG ---
    - name: Push to ADG branch
      run: |
        git checkout --orphan adg
        git rm -rf .
        mkdir -p rules
        cp -r output/adg/* rules/
        git add rules/*
        git commit -m "Auto Update ADG $(date +"%Y-%m-%d %H:%M")"
        git push -f origin adg

    # --- 任务 C: 推送 MosDNS-X ---
    - name: Push to MosDNS-X branch
      run: |
        git checkout --orphan mosdns-x
        git rm -rf .
        mkdir -p rules
        cp -r output/mosdns-x/* rules/
        git add rules/*
        git commit -m "Auto Update MosDNS $(date +"%Y-%m-%d %H:%M")"
        git push -f origin mosdns-x

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 2
